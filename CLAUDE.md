# CLAUDE.md - civic-summary

Go CLI that transforms YouTube recordings of government meetings into citizen-friendly Obsidian markdown summaries.

## Architecture

```
cmd/                    # Cobra command tree (root, process, discover, transcribe, analyze, crossref, validate, status, quarantine, bodies)
internal/
  config/               # Viper config loading, body parsing, env binding
  domain/               # DDD types: Meeting, Body, Transcript, Summary, QuarantineEntry, ValidationResult
  executor/             # CommandExecutor interface + YtDlp, Whisper, Claude wrappers (mockable)
  markdown/             # Frontmatter parse/inject, sanitize Claude output, wikilink generation
  output/               # Logger setup, terminal formatting, macOS notifications
  retry/                # Generic retry with exponential backoff
  service/              # Pipeline services: Discovery, Transcription, Analysis, CrossRef, Validation, Quarantine, Index, PipelineOrchestrator
templates/              # Externalized Go text/template prompt files (not compiled into binary)
testdata/fixtures/      # Golden test data: config, SRT, summaries
```

## Pipeline Stages

```
Discovery -> Transcription -> Analysis -> CrossReference -> Validation
  (yt-dlp)    (captions/       (Claude      (date->          (frontmatter,
               whisper)         CLI)         wikilinks)        sections,
                                                               word count)
```

## Key Commands

```bash
make build              # Build binary with version ldflags
make test               # Run all tests
make lint               # golangci-lint
make coverage           # Coverage report with HTML output
go test ./... -v        # Verbose tests
```

## Configuration

Config file: `~/.civic-summary/config.yaml`

Environment variables: `CIVIC_SUMMARY_*` prefix (12-Factor compliant)

Bodies are config-driven: adding a new government body requires only YAML config + prompt template, no code changes.

## Design Decisions

- **CommandExecutor interface**: All shell-outs go through mockable interface for unit testing
- **Externalized prompts**: Go `text/template` files in `templates/`, not compiled into binary
- **Config-driven bodies**: Body configuration in YAML, not code
- **Quarantine**: Failed meetings stored with metadata JSON for retry
- **Cross-references**: Obsidian wikilinks generated by matching date patterns to existing summary files

## Testing

- Unit tests with mock executors (no real binaries needed)
- Golden fixtures in `testdata/fixtures/`
- `go test ./...` for all tests
- Integration tests (real yt-dlp/whisper/claude) gated behind `//go:build integration`

## Dependencies

| Library | Purpose |
|---------|---------|
| spf13/cobra | CLI framework |
| spf13/viper | Config management |
| stretchr/testify | Test assertions |
| gopkg.in/yaml.v3 | YAML frontmatter |
| stdlib | text/template, os/exec, regexp, log/slog |
